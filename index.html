<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="ocean.css" />
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3, h4 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      h4 {
        font-size: 1.3em;
        margin: 20px 0px;
      }
      .splash h1, .splash h2 {
        background-color: black;
        opacity: 0.8;
      }
      .large code { font-size: 1.5em }
      .large .hljs-comment { color: white !important}
      .squeez h3 { margin: 0.5em }
      .fade {color: #E0E0E0}
      .spanny { padding: 10px; color: white; background-color: #0b1c2e }
      .nopadding { padding: 0 }
      .libs { background-color: #202020}
      .l50 { float: left; width: 50%; }
      .r50 { float: right; width: 50%; }
      .crap pre { border-right: 5px solid #D81F2A; }
      .nice pre { border-right: 5px solid #69F0AE; }
      /* new */
      .example { background-color: black}
      .example h2, .example h3 { color: #fff; font-weight: bold; line-height: 0;}
      .example h1 { color: #fff; font-weight: bold; padding: 10px }

      .codeonly h1, .codeonly h2, .codeonly h3, .codeonly h4 { color: white }
      .codeonly { padding: 1em; background-color: black }
      .codeonly pre { margin: 0 }

      .remark-code-line-highlighted { background-color: #2d9967; color: white}
      .remark-code-line-highlighted * { color: white !important; }

      .remark-slide-scaler { -webkit-box-shadow: 0 !important; box-shadow: none !important; }
      .remark-slide-container {background-color: black}
      /* new end */
      .corner {border: 5px solid #85C1E9; position: absolute; top: 0px; right: 0px; width: 50%; background-color: #F0F0F0}
      .corner pre {margin: 0; padding: 0}
      .corner.long {height: 300px;}

      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; background-color: black !important }
      .invert { background-color: black; color: white; }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}
      .strike { text-decoration: line-through; }
      .lint { background-color: #f3f3f3; }
      .conversation h3 { margin: 17px; font-size: 28px; }
      .img100 img { width: 100%}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle, example
background-size: contain
# Effective Coding Principles and Patterns 
### (Java 17 edition)

---
# Agenda:
### Day I: Code design principles (3/4) and exercises (1/4)

--

### Day II: Enterprise Java (validation, persistence, tx etc.)

--

### Homework with free code review

---
class: codeonly
.crap[
```java
var users = repository.allUsers();
users
  .flatMap(user -> user.contacts().phoneNumbers().stream())
  .map(PhoneNumber::countryCode)
  .forEach(System.out::println);
```
]

--

### ‚ö†Ô∏è Refactoring needed.

--

```java
var users = repository.allUsers();
users
* .flatMap(User::phoneNumbers)
  .map(PhoneNumber::countryCode)
  .forEach(System.out::println);


class User {
  public Stream<PhoneNumber> phoneNumbers() {
      return this.contacts().phoneNumbers().stream();
  }
}  
```

--

#### üí° Principle: reveal intent, hide implementation

--

#### üí° Principle: keep code at the same level of abstraction (SLAP)

--

#### üí°  Law of Demeter: don't talk to you strangers

---
class: codeonly
### New requirement: Print country code with exit code. Digits validation needed.

--

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(User::phoneNumbers)
          .map(PhoneNumber::countryCode)
          .map(countryCode -> {
              var pattern = "^(?:\\+)?(?:\\d)+$";
              var matches = countryCode.matches(pattern);
              checkArgument(matches, "Country code %s doesn't match %s pattern", countryCode, regex);
            
              if (countryCode.startsWith("+")) {
                return countryCode;
              } else {
                return "+" + countryCode;
              }
          })
          .forEach(System.out::println);
```

--

### ‚ö†Ô∏è Mixed intent with implementation

### ‚ö†Ô∏è Mixed levels of abstraction

---
class: codeonly

### Refactoring: extract method

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(User::phoneNumbers)
          .map(PhoneNumber::countryCode)
*         .map(this::countryCodeWithExitCode)
          .forEach(System.out::println);
```

```java
private String countryCodeWithExitCode(String countryCode) {
  var pattern = "^(?:\\+)?(?:\\d)+$";
  var matches = countryCode.matches(pattern);
  checkArgument(matches, "Country code %s doesn't match %s pattern", countryCode, regex);

  if (countryCode.startsWith("+")) {
    return countryCode;
  } else {
    return "+" + countryCode;
  }
}
```

--

### ‚ö†Ô∏è Smell: private method explosion


---
class: codeonly

```java
private String countryCodeWithExitCode(String countryCode) {
  var pattern = "^(?:\\+)?(?:\\d)+$";
  var matches = countryCode.matches(pattern);
  checkArgument(matches, "Country code %s doesn't match %s pattern", countryCode, regex);

  if (countryCode.startsWith("+")) {
    return countryCode;
  } else {
    return "+" + countryCode;
  }
}
```

--

### üí° Principle: extract classes hiding as methods

--

```java
class CountryCode {

  private final static VerbalExpression PATTERN = regex().startOfLine().maybe("+").digit().oneOrMore().endOfLine().build();

  private final String withoutExitCode;

  CountryCode(String withOptionalExitCode) {
      var matches = PATTERN.testExact(withOptionalExitCode);
      checkArgument(matches, "Country code %s doesn't match %s pattern", withOptionalExitCode, PATTERN);

      this.withoutExitCode = withOptionalExitCode.replace("+", "");
  }

  public String withExitCode() {
      return "+" + this.withoutExitCode;
  }
  
}
```

---
class: codeonly

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(User::phoneNumbers)
          .map(PhoneNumber::countryCode)
*         .map(this::countryCodeWithExitCode)
          .forEach(System.out::println);
```

--

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(User::phoneNumbers)
          .map(PhoneNumber::countryCode)          
*         .map(CountryCode::new)
*         .map(CountryCode::withExitCode)
          .forEach(System.out::println);
```

--

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(User::phoneNumbers)
          .map(PhoneNumber::countryCode)          
*         .map(CountryCode::withExitCode)
          .forEach(System.out::println);
```



---
class: codeonly
### üí° Principle: minimum visibility, maximum proximity.
### 1. **local** interface/enum/class
### 2. **internal**
### 3. **package-private**
### 4. **public**
### 5. **public**, different package
### 6. **public**, different module
???
to express belonging.


---
class: codeonly
### **implicit conversion**

```java
class BitcoinExchange {
    BitcoinExchange(BitcoinExchange.Rate rate) {
        this.rate = rate;
    }
    void sell(Bitcoin btc) { ... rate.decimal() ... }
    void buy(Bitcoin btc) { ... rate.decimal() ... }

    @FunctionalInterface
    interface Rate {
        BigDecimal decimal();
    }
}
```

--
```java
class Coinbase {
    public BigDecimal exchangeRate() {
        return remoteApi.fetchExchangeRate();
    }
}
```

--

```java
var coinbase = new Coinbase();
```
--

```java
*var exchange = new BitcoinExchange(coinbase::exchangeRate);
```

### üöÄ No need to implement `BitcoinExchange.Rate`

---

class: center, middle, codeonly
## üí° Rule: functional interfaces simplify system extension.
### (Interface Segregation Principle)
???
this way you can eliminate factories, wrappers.

---
class: codeonly
### üí° Interface Segregation Principle: **slim** over **FAT** interfaces

.crap[
```java
interface ProductService {
  BigDecimal maxLoanAmount();
  AffiliateFees affiliateFees();
  Limits investmentLimits(Investor investor);
}
```
]

--

#### üî¥ Low cohesion.

--

#### üî¥ Fat implementation.

.crap[
```java
class DefaultProductService implements ProductService {
  DefaultProductService(..., ..., ..., ..., ..., ..., ü§¨)
}
```
]

#### üî¥ High afferent (inward) and efferent (outward) coupling.

--

#### üî¥ All-or-nothing implementation.

--

#### üî¥ Gives no hints: **new Investor(ProductService)** vs. **new Investor(InvestmentLimits)**

--

#### üü¢ Easier to use (Fa√ßade)

---
class: codeonly

### üí° Reification (implicit -> explicit)

.crap[
```java
if (productsOwnedByPo.get(po.id()).containsKey(product.id())) {
  ...
}
```
]

--

.nice[
```java
if (productOwner.owns(product)) {
  ...
}
```
]

--

.crap[
```java

Map<Integer, BigDecimal> extensionFees = loan.extensionFees(borrower); // üî¥ SLAP violation
```
]

--

.nice[
```java
Collection<ExtensionFee> extensionFees = loan.extensionFees(borrower); // üü° OK
```
]

--

.crap[
```java
var cheapestExtensionFee = extensionFees.get(0);
var term = cheapestExtensionFee.term();
var fee = cheapestExtensionFee.fee();
```
]


--

.nice[
```java


ExtensionFees extensionFees = loan.extensionFees(borrower);            // üü¢ Love
```
]

--

.nice[
```java
var cheapestExtensionFee = extensionFees.cheapest();
var term = cheapestExtensionFee.term();
var fee = cheapestExtensionFee.fee();
```
]

---
class: codeonly
.crap[
```java
MultivaluedMap<String, String> formParams = new MultivaluedMap<>();
for (String key : httpRequest.params().keySet()) {
    formParams.add(key, httpRequest.params().get(key));
}
```
]

--

.crap[
```java
Form form = new Form();
for (String key : httpRequest.params().keySet()) {
  form.add(key, httpRequest.params().get(key));
}
```
]

--

.crap[
```java
Form form = new Form(new Parameters(httpRequest));
```
]


--

.nice[
```java
Form form = new Form();
form.with(Parameters.from(httpRequest));
```
]

---
class: center, middle, example
# Naming
### (and how it impacts software design)

---
class: codeonly

#### üë©‚Äçüíº **Product Owner**: hey, what happens upon registration?

--
class: codeonly
```java
void register(RegistrationForm registrationForm) {
  var member = newMember(registrationForm);
  grantRegistrationBonus(member);
  subscribeToNewsletter(member);
  sendWelcomeEmail(member);
}
```

--

#### Code "never" lies:

.crap[
```java
private Member newMember(RegistrationForm form) {
  var member = new Member(form.username(), form.password(), ...);
  if (!blacklist.allows(member)) {
    throw new MemberBlacklistedException();
  }
  return member;
}
```
]

---
class: codeonly

#### üë©‚Äçüíº **Product Owner**: hey, what happens upon registration?

```java
void register(RegistrationForm registrationForm) {
  var member = newMember(registrationForm);
  grantRegistrationBonus(member);
  subscribeToNewsletter(member);
  sendWelcomeEmail(member);
}
```

#### Code "never" lies:

.crap[
```java
private void grantRegistrationBonus(Member member) {
  if (!member.isGold()) {
    return;
  }
```
]

---
class: codeonly

#### üë©‚Äçüíº **Product Owner**: hey, what happens upon registration?

```java
void register(RegistrationForm registrationForm) {
  var member = newMember(registrationForm);
  grantRegistrationBonus(member);
  subscribeToNewsletter(member);
  sendWelcomeEmail(member);
}
```

#### Code "never" lies:

.crap[
```java
private void subscribeToNewsletter(Member member) {
  var agreedToReceiveNews = member.hasAgreedToReceiveNews();
  if (agreedToReceiveNews) {
    newsletter.subscribe(member);
  }
```
]

---
class: codeonly

#### üë©‚Äçüíº **Product Owner**: hey, what happens upon registration?

```java
void register(RegistrationForm registrationForm) {
  var member = newMember(registrationForm);
  grantRegistrationBonus(member);
  subscribeToNewsletter(member);
  sendWelcomeEmail(member);
}
```

#### Code "never" lies:
.crap[
```java
private void sendWelcomeEmail(Member member) {
  emailService.sendWelcome(member.email());
}
```
]

```java
class EmailService {
  void sendWelcome(String email) {
    jms.enque(MIDNIGHT, new WelcomeEmail(email));
  }
```

---
class: codeonly

#### üí° Principle: make important side-effects visible (renaming)

.nice[
```java
void register(RegistrationForm registrationForm) {
  var member = newMemberIfNotBlacklisted(registrationForm);
  grantRegistrationBonusIfEligible(member);
  subscribeIfAgreedToReceiveNews(member);
  scheduleWelcomeEmail(member);
}
```
]

--

#### üí° Principle: make important side-effects visible (method extraction)

.nice[
```java
void register(RegistrationForm registrationForm) {
  var member = newMember(registrationForm);
  throwIfBlacklisted(member);

  if (isEligibleForBonus(member)) {
    grantRegistrationBonus(member);
  }

  if (agreedToReceiveNews(member)) {
    subscribeToNewsletter(member);
  }
  
  scheduleWelcomeEmail(member);
}
```
]

--

#### üí° Take-away: optimize code for "discovery cost" so it always gives **quick** and **correct** answers to the reader.

--

#### üí° Take-away: if readers don't trust code, they go N levels down to find right answers.

---
class: codeonly

.crap[
```java
interface TransactionManager {
  void cancelTransaction(Transaction transaction) { ... } 
}
```
]

--

.nice[
```java
interface TransactionManager {
  void cancel(Transaction transaction) { ... } 
}
```
]

--

.crap[
```java
mergeTableCells(List<TableCell> cells)
```
]

--

.nice[
```java
merge(List<TableCell> cells)
```
]

--

.nice[
```
merge(TableCells cells) // once we reify, we might introduce cells.merge()
```
]

--

.crap[
```java
interface Employee {
  String employeeAddress();
}
```
]

--

.nice[
```java
interface Employee {
  String address();
}
```
]

--

.crap[
```
AutoClosableWindow autoClosableWindow;
```  
]

--

.nice[
```
AutoClosableWindow window;
```  
]

--

.crap[
```
Map<Employee, Role> employeeRolesMap;
```  
]

--

.nice[
```
Map<Employee, Role> employeeRoles;
```  
]

--

.nice[
```
EmployeeRoles employeeRoles;
```  
]

--

#### üí° Principle: Omit words deductable from the context.

---
class: codeonly
background-image:url(clientnamespace.jpg)
background-size: contain


---
class: codeonly

.crap[
```java
class Transaction {
  enum TransactionScope { }
}
```
]

--

.nice[
```java
class Transaction {
  enum Scope { }
}
```
]

--

.crap[
```java
package org.framework.batch
interface Reader { }
interface Operation { }
```
]

--

.nice[
```java
interface BatchReader { }
interface BatchOperation { }
```
]

--

.nice[
```java
interface Batch {
  interface Reader { }
  interface Operation { }
}
```
]

--

.crap[
```java
var rollbackOperation = new DatabaseRollbackOperation();
var commitOperation = new DatabaseCommitOperation();
```
]

--

.crap[
```java
var rollbackOperation = new DatabaseOperation.Rollback();
var commitOperation = new DatabaseOperation.Commit();
```
]

--

.nice[
```java
import static my.app.DatabaseOperation.*;
var rollback = new Rollback();
var commit = new Commit();
```
]

--

### üí°Principle: create context to omit unnecessary words.

---
class: codeonly

.crap[
```
var connection = new BlockingQueueDatabaseConnection();
```
]
--

.nice[
```
var connection = new ThreadSafeConnection();
```
]

--

.nice[
```
var connection = new ConcurrentConnection();
```
]

--

.crap[
```
Browser browser = ConcurrentSingletonBrowserFactory.getChromeBrowserInstance();
```
]

--

.crap[
```
Browser browser = Browsers.chrome();
```
]
--

### üí° Principle: don't leak (too many) technical details into the name.

---
class: codeonly

.crap[
```java
class Widget {
    long length();
```
]

--

.nice[
```java
class Widget {
    Pixels length();
```
]

--

.crap[
```java

interface DockerContainer {
    String spinUp();
}
```
]
--


.nice[
```java
interface DockerContainer {
    Port spinUp();
}
```
]

--

.crap[
```java

interface Jetty {
    void run(int port); // where to look for a default port?
}
```
]

--

.nice[
```java
interface Jetty {
    void run(Port port);
}
```
]

--

.nice[
```java
interface Port {
  Port DEFAULT = () -> 8080;
  int num();
}
```
]

--

#### üí° Principle: use strong types to add the context and reduce discovery cost.

--

#### üçø 10 reasons why we love some APIs and hate others: dev.tube/video/NJpQVIZhIYk

---
class: codeonly
### üí° Heuristic: compound names usually indicate a missing object.

.crap[
```java
loan.agreementDueDate();
loan.agreementStatus();
loan.closeAgreement();
```
]

--

.nice[
```java
var agreement = loan.agreement();
agreement.dueDate();
agreement.status();
agreement.close();
```
]

--

.crap[
```java


conference.isCfpOpen();
conference.cfpEndDate();
conference.cfpStartDate();
conference.cfpUrl();
conference.closeCfp();
```
]

--

.nice[
```java
var cfp = conference.cfp();
cfp.isOpen();
cfp.startDate();
cfp.endDate();
cfp.url();
cfp.close();
```
]

---
class: codeonly
.crap[
```java
interface SpotifyApp {
    void playMusic();
    void stopMusic();
}
```
]

--

.nice[
```java
interface Music {
    void stop();
    void play();
}
```
]

--

.nice[
```java
interface SpotifyApp {
    Music music();
}
```
]

--

class: codeonly
.crap[
```java
interface Slack {
    void sendMessage(String channel, String mesage);
}
```
]

--

#### Option A
.nice[
```java
interface Slack {
    void send(Message message); // Message contains text and channel
}
```
]

--

#### Option B

.nice[
```java
interface Slack {
    Channel channel(String name);
}
```
]

--

.nice[
```java
interface Channel {
    void send(Message message);
}
```
]

---
class: center, middle
# Methods are either **commands** or **queries**.
### Use commands (verbs) to tell an object what to do.
### Use queries (nouns) to ask object give you something.
‚Äî *[Command/Query Separation](http://martinfowler.com/bliki/CommandQuerySeparation.html)*

---
class: codeonly
.crap[
```java
interface Iterator<T> {
  T next();
```
]

--

.nice[
```java
interface Iterator<T> {
  // command to tell an object what to do (verb)
  void advance();

  // query to ask for state (noun)
  T current();
```
]

--

.crap[
```java


InputStream stream = webPage.crawl();
```
]

--

.nice[
```java
InputStream stream = webPage.content(); // under the hood, an object might do something big!
```
]

--

.crap[
```java
webPage.crawl().transferTo(...)
```
]

--

.nice[
```java
webPage.content().transferTo(...)
```
]

--

.crap[
```java


user.getFullName(); // if (user.getFullName().equals(...))
```
]

--

.nice[
```java
user.fullName();    // if (user.fullName().equals(...))
```
]

--

.crap[
```java


getOngoingTransaction().pointsTo(...)
```
]

--

.nice[
```java
ongoingTransaction().pointsTo(...)
```
]

--

#### ‚ö†Ô∏è Queries that return boolean are not nouns. Keep using using **is**, **has** etc.

---
class: codeonly

## üí° In 10% cases CQS is worth violating:

#### ‚ö†Ô∏è Command (verb) returns a result
```
interface Command<R> {
  R execute();
```

--

#### üí© Temporal coupling
```
interface Command<R> {
  void execute();
  R result();
```

--


#### üí© Naming inconsistent with a well-known GoF pattern
```
interface Command<R> {
  R result();
```

--

#### ‚úÖ Just violate CQS

```
interface Command<R> {
  R execute();
```

---
class: codeonly, center, middle
# Objects vs. data classes vs. procedures

---
class: codeonly

#### **Data class** ‚Äî exposes raw state, has no behaviour.
#### **Procedure** ‚Äî takes a data class, and adds some random "logic" to it.

--

```java
class BankAccount {
  private Collection<Transaction> transactions;
  private Status status;
  private BigDecimal limits;

  Collection<Transaction> getTransactions() { ... }
  void setTransactions(Collection<Transaction> transactions) { ... }

  Status getStatus() { ... }
  void setStatus(Status status) { ... }
  ...
}

class BankAccountService { ... }
class BankAccountJsonConverter { ... }
class BankAccountUtils { ... }
```

--

#### üî¥ State invariants are **not** enforced and are **not** visible in code and tests.

--

#### üî¥ Uncontrolled state leakage and high afferent coupling to "internals". Maximum proximity, minimum visibility helps a bit.

--

#### üî¥ Too easy to add behaviour w/o thinking where it actually belongs / re-modeling.

--

#### üî¥ "Meaningless" classes from the domain perspective (utils, converter, service).

---
class: codeonly
### - DTOs and Java Beans are data classes.

--

### - Because data classes don't have behavior, they have no tests.

--

### - Because data classes don't provide encapsulation, getters/setters can be omitted.

---
class: codeonly
```java
class User {
    private final String firstName;
    private final String lastName;
    private String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    // getters and a setter for middleName

    @Override
    public String toString() {
        return "User{" +
                "firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", middleName='" + middleName + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return "User{" +
                "firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", middleName='" + middleName + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this);
    }

    @Override
    public boolean equals(Object o) {
        return EqualsBuilder.reflectionEquals(this, that);
    }

    @Override
    public int hashCode() {
        return HashCodeBuilder.reflectionHashCode(this);
    }
}
```

---
class: codeonly
```java
class User extends Data {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

}
```

--
```java
User user = new User("Robert", "Martin");
user.middleName = "Cecil"
```

--

### üí° Alternatives:
#### - github.com/google/auto
#### - github.com/rzwitserloot/lombok
#### - github.com/immutables/immutables ‚ù§Ô∏è
#### - records (very limited)


---
class: codeonly

#### **Object** ‚Äî hides and protects state, exposes behaviour.

--

```java
class BankAccount {
  private Collection<Transaction> transactions;
  private Status status;
  private BigDecimal limits;

  void close() { ... }
  void withdraw(BigDecimal amount) { ... }
  void deposit(BigDecimal amount) { ... }

  BigDecimal amount() { ... }
  Json json() { ... }
}
```

--

#### üü¢ State invariants are **enforced** and **visible** in code and tests.

--

#### üü¢ State is hidden, doesn't leak uncontrollably, and clients are coupled only to limited set of behaviours.

--

#### üü¢ Adding behaviour forces you to think where it belongs, usually triggering re-modeling.

--

#### üü¢ Only meaningful domain classes have remained.

--

#### üî¥ Tend to grow big. 

--

#### üî¥ OOA&D/DDD in data-driven and CRUD apps is an overkill.

---
class: codeonly

#### **Object** ‚Äî no setters.

.crap[
```java
Borrower borrower = new Borrower();
borrower.setFirstName(firstName);
borrower.setLastName(lastName);
```
]

--

.nice[
```java
borrower.change(ProfileInfo profileInfo);
```
]

--

.crap[
```java
agreement.setSigned(boolean signed);
agreement.setOwner(Borrower borrower);
```
]

--

.nice[
```java
agreement.sign(Borrower borrower);
```
]

--

.nice[
```java
agreement.callOff();
```
]

--

.nice[
```java
agreement.suspendFraudulent();
```
]

--

.crap[
```java
user.setIpAddress(String ipAddress);
```
]

--

.nice[
```java
user.register(RegistrationInfo registrationInfo);
```
]

--

.nice[
```java
user.visitWebsite(GeoLocation location);
```
]

--

.nice[
```java
loanApplication.isADrunkDecision(LendingPolicy lendingPolicy);
```
]

--

.nice[
```java
bankAccount.close(UnsatisfiedObligations unsatisfiedObligations);
```
]

#### üí° An objects can depend on other objects to protect its invariants (hello, Domain-Driven Design)

---
class: codeonly

#### **Object** ‚Äî let's encapsulate the state...

.crap[
```java
interface ConditionChecker {
  boolean check(Condition condition)
```
]

--

.nice[
```java
interface Condition {
  boolean isFulfilled();
```
]

--

.crap[
```java

interface CredentialValidator {
  boolean validate(String username, String password);
```
]

--

.nice[```java
interface Credentials {
  boolean areValid();
```
]

.crap[

```java

interface FileSystem {
    boolean isEmpty(File file);        
```
]

--

.nice[
```java
class File {
    boolean isEmpty();                   
```  
]

--

.crap[
```java

interface RegistrationService {
  void register(String username, String password);
```
]

--

.nice[
```java
interface Registration {
  void complete();
```
]

---
class: codeonly

#### **Object** ‚Äî let's encapsulate the state...

.crap[
```java
class PaymentJsonConverter {
  Json convert(Payment payment) { ... } // "converter" must know everything about the payment's internals :(
```
]

--

.nice[
```java
class Payment {
  Json json() { ... }
```
]

--

#### ü§î Concern: I might need different converters "in future"

--

#### üí° Flexibility breeds complexity / use&reuse paradox ‚Äî Kirk Knoernschild, Java Application Architecture

--

#### üí° Decide as late as possible ‚Äî Lean Principle #4

--

#### üí° Simplicity, the art of maximizing the amount of work not done, is essential ‚Äî Agile Manifesto

--

.nice[
```java
class Payment {
  Json jsonForSwedbank() { ... }
  Json jsonForLuminor() { ... }
  Json jsonForSeb() { ... }
```
]

--

.nice[
```java
class Payment {
  Json json(Format format) { ... }
```
]

--

.nice[
```
class SebPayment extends Payment {
  Json json() { ... }
```
]



---
class: codeonly
#### **Object** ‚Äî you can't **always** keep behaviour next to the state. 

// oops: 
.crap[
```java
class File { ... }                           // üü° third-party class 
```
]

--

.crap[
```java
class FileReader {                           // üî¥ Meaningless domain class
    String read(File file);                  // üî¥ CQS violation
```
]

--

.crap[
```java
class FileReader {
  String content(File file);                 // üî¥ file reader's content?
```
]

--

.nice[
```java
class TextFile {                             // üü¢ Meaningfull domain class
  TextFile(File file) { ... }
  String content() { ... }                   // üü¢ CQS compliant
}
```
]

--

.nice[
```java
var textFile = new TextFile(file);
var content = textFile.content();            // üü¢ file's content
```
]

--

.nice[
```java
class Content {                              // üü¢ Alternative
  Content(TextFile file) { ... }
  String toString() { ... }
}
```
]

--

.nice[
```java
var textFile = new TextFile(file);
System.out.println("Text file's content is: " + new Content(textFile)); // or Content.of(textFile)
```
]

---
class: center, middle, example
# Tony Hoare's billion dollar mistake

---
class: center, middle
## If nulls are possible, make them explicit. Rely on compiler to catch missing null checks.

---

class: codeonly
```kotlin

plugins {
  java
  id("net.ltgt.errorprone") version "0.8.1"
}

dependencies {
  errorprone("com.google.errorprone:error_prone_core:2.3.3")
  errorprone("com.uber.nullaway:nullaway:0.7.5")
}
```

--

```java
public String greet() {
  greetings(null);
  return null;
}

public String greetings(String name) {
  return "Hello, " + name;
}
```

--

```whatever

[NullAway] returning @Nullable expression from method with @NonNull return type
1 warning

[NullAway] passing @Nullable parameter 'null' where @NonNull is required
1 warning
```

---
class: center, middle
## In new code, use optionals instead of nulls.
### Mythbuster: Optional fields are fine.

---
class: codeonly

.crap[
```java
interface PhoneBook {
  PhoneNumber phoneNumber(String regex);
}
```
]
--
.nice[
```java
interface PhoneBook {
  Optional<PhoneNumber> phoneNumber(String regex);
}
```
]

--

#### üí© Pyramid of Doom

.crap[
```java

PhoneNumber phoneNumber = phoneBook.phoneNumber(...);
if (phoneNumber != null) {
  FacebookProfile facebookProfile = facebook.profile(phoneNumber);
  if (facebookProfile != null) {
    Picture picture = facebookProfile.picture();
    if (picture != null) {
      picture.download();
    }
  }
}
```
]

--

.nice[
```java
phoneBook.phoneNumber(...)
    .flatMap(facebook::profile)
    .flatMap(FacebookProfile::picture)
    .ifPresent(ProfilePicture::download);
```
]

---
class: codeonly
.crap[
```java
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(Optional<String> regex); üí©
}
```
]

--

#### üí° Strategy Pattern

--

```java
interface Mask {

  Mask ANY = phoneNumber -> true;

  boolean matches(PhoneNumber phoneNumber);
}
```

--

```java
class Regex implements Mask {

  private final Pattern regex;

  @Override
  public boolean matches(PhoneNumber phoneNumber) {
    return regex.asPredicate().test(phoneNumber.toString());
  }
}
```

--

```java
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(Mask mask);
}```

--

```java
phoneBook.phoneNumbers(Mask.ANY);

phoneBook.phoneNumbers(new Regex(...));

```


---
class: codeonly

.crap[
```java
class Application {
  private Banner banner;

  public void boot() {
    if (banner != null) { üí©
      banner.print();
    } else {
      logger.warn("Banner has not been set.");
    }
  }
```
]

--

#### üí° Null Object Pattern

--

.nice[
```
  class NoBanner implements Banner {
    @Override
    public void print() {
      logger.warn("Banner has not been set.")
    }
  }
```
]

--

.nice[
```java
class Application {
* private Banner banner = new NoBanner();

  public void boot() {
*     banner.print();
  }
```
]

---
class: codeonly

```java
class Selenium {

  Optional<Element> elementBy(String cssSelector) {
      if (!found) {
          return Optional.empty(); // why?
      }
      if (!visible) {
          return Optional.empty(); // why?
      }
      return Optional.of(new Element(cssSelector));
  }

}
```

--

#### üí° github.com/google/mug

--

```java
class Selenium {

  Maybe<Element, ElementLookupException> elementBy(String cssSelector) {
      if (!found) {
          return except(new ElementNotFoundException());
      }
      if (!visible) {
          return except(new ElementIsHiddenException());
      }
      return Maybe.of(new Element(cssSelector));
  }

}
```

--

```java
selenium.elementBy(".header").ifPresent(Element::click).orElseThrow();
```

---
class: middle, center, example
# Growth control.
### ... because we want to keep object's behaviour next to the state

---
class: center, middle
# Pattern I: Object mother.

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

```
--

```java
    LikesAnalytics likesAnalytics() {
      return new LikesAnalytics(total, dailyMinimum, dailyMaximum, dailyAverage);
    }
```

--

```java
    void likesFoo() { ... }    

    void likesBar() { ... }

}
```

--

```
public class Likes {

  private final Collection<Like> likes;

  Likes(Collection<Like> likes) { this.likes = likes; }

  LikesAnalytics analytics() { ... }

  void foo() { ... }

  void bar() { ... }
}
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

```

```java
    LikesAnalytics likesAnalytics() {
      return new LikesAnalytics(total, dailyMinimum, dailyMaximum, dailyAverage);
    }
```

```java
    void likesFoo() { ... }    

    void likesBar() { ... }

}
```

```
public class Likes extends ForwardingList<Like> {

  private final Collection<Like> likes;

  Likes(Collection<Like> likes) { this.likes = likes; }

  LikesAnalytics analytics() { ... }

  void foo() { ... }
  
  void bar() { ... }

  @Override
  protected List<Like> delegate() {
      return ImmutableList.of(likes);
  }  
}
```

---
class: codeonly

```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

*   public Likes likes() {
*       return new Likes(likes);
*   }

}
```

--
```java
  tweet.likes().analytics();
  
  tweet.likes().forEach(System::out.println);
```


---
class: center, middle
# Pattern 2: Decomposition.

---
class: center, middle
## Total likes during Black Friday?

---
class: codeonly
```java
class BlackFriday {
```

--

```java
    public boolean fallsOn(LocalDate date) {
        var blackFriday = thanksgiving().plusDays(1);
        return blackFriday.isEqual(date);
    }
```

--

```java
    private LocalDate thanksgiving() {
        return LocalDate
          .now()
          .with(Month.NOVEMBER)
          .with(TemporalAdjusters.lastInMonth(THURSDAY));
    }
}
```

--

```java
class Likes {
    ...
    public long totalDuring(BlackFriday blackFriday) {
        return likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
    ...
}
```


---
class: center, middle
# Pattern III: Queries.


---
class: codeonly
```java
@FunctionalInterface
interface Query<T, R> {
    R result(T entity);
}
```

--

```java
public interface Entity<T> {
    default <R> R query(Query<T, R> query) {
        return query.result((T) this);
    }
}
```

--

```java
class Likes implements Entity<Likes> {
  ...
}
```

--

```java
class TotalDuringBlackFriday implements Query<Tweet.Likes, Long> {

    private final BlackFriday blackFriday = new BlackFriday();

    @Override
    public Long result(Tweet.Likes likes) {
        return
          likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
}
```

--

```java
Tweet tweet = ...
Tweet.Likes likes = tweet.likes();
long total = likes.query(new TotalDuringBlackFriday());
```
???
- must side effect free!
- btw, can be written inline, as lambdas
- PACKAGING MATTERS! under .likes


---
class: center, middle
# Pattern IV: Specifications.

---
class: codeonly
```java

@FunctionalInterface
interface Specification<T> {
    boolean isSatisfiedBy(T entity);
}
```

--

```java
public interface Entity<T> {
    default <R> R query(Query<T, R> query) {
        return query.result((T) this);
    }

    default boolean satisfies(Specification<T> specification) {
        return specification.isSatisfiedBy((T) this);
    }
}
```

--

```java
class GotMillionLikesOnAPostingDay implements Specification<Tweet> {

        @Override
        public boolean isSatisfiedBy(Tweet tweet) {
            long likesOnAPostingDay = tweet
                    .likes()
                    .stream()
                    .filter(like -> like.isGivenOn(tweet.date()))
                    .count();
            return likesOnAPostingDay >= 1000000;
        }
    }
```

--
```java
Tweet tweet = ...
boolean milionLikesInADay = tweet.satisfies(new GotMillionLikesOnAPostingDay());
```


---

class: center, middle
# Pattern V: Events

---
class: codeonly
```java
  class Tweet {

    void delete() {
      this.deleted = true;
      this.deletionTime = new LocalDateTime.now();
      DomainEvents.send(new TweetDeleted(this));
    }

  }
```

--

```java
@Component
class UpdateFeedOnTweetDeleted {

  @Autowired
  Database database;

  @TransactionalEventListener
  void triggerBy(TweetDeleted event) {
    ...
  }

}
```

---

class: center, middle
# Pattern VI: Roles

---
class: codeonly
### üí° An object can have different representations (roles) in the system.

--

```java
class Client {
  String firstName;
  String lastName;
  String personalId;
  Email email;
  Collection<Subscription> subscriptions;
  SubscriptionSettings subscriptionSettings;
  Collection<Loans> loans;
  Collection<LoanApplication> loanApplications;
}
```

---
class: codeonly
### üí° An object can have different representations (roles) in the system.

```java
class Client {
  String firstName;
  String lastName;
  String personalId;
  Email email;
}

class Subscriber {
  Collection<Subscription> subscriptions;
  SubscriptionSettings subscriptionSettings;
}

class Borrower {
  Collection<Loans> loans;
  Collection<LoanApplication> loanApplications;
}
```

---

class: center, middle
# üë®‚Äçüíª üë©‚Äçüíª bit.ly/java_practice


---
class: center, middle
# [Part II](part_2.html)

    </textarea>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/java.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        highlightLanguage: 'java',
        click: true,
        touch: true,
        ratio: '16:9'
      });
      slideshow.on('afterShowSlide', function (slide) {

        var axs =  {
                  title: 'thoughput / responsiveness over time.',
                  xaxis: {
                    title: 'time (months)'
                  },
                  yaxis: {
                    title: 'throughput / responsiveness (RTF / sprint)'
                  }
                }

        var thr = [
                {
                  x: [2, 10, 14, 24, 40],
                  y: [30, 29, 28, 23, 10],
                  name: 'continuous degradation',
                  mode: 'lines',
                  line: {
                      color: 'rgb(219, 64, 82)',
                      width: 3
                    }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30, 30, 30, 30],
                  name: 'sustainable pace',
                  mode: 'lines',
                  line: {
                      color: 'rgb(169, 169, 169)'
                  }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30.5, 31, 31.5, 32],
                  name: 'continuous improvement',
                  mode: 'lines'
                },
          ];

          var dbt = thr.concat({
                  x: [28, 28],
                  y: [30, 20],
                  name: 'technical debt',
                  mode: 'lines',
                  line: {
                    dash: 'dot'
                  }
                } );

        if (slide.properties.name == "throughput") {
          Plotly.newPlot('throughput', thr, axs);
        }
        if (slide.properties.name == "debt") {
          Plotly.newPlot('debt', dbt, axs);
        }
      });

    var ktx = document.getElementsByClassName("ktx");
    for(var i = 0; i < ktx.length; i++) {
       katex.render(ktx.item(i).getAttribute('expr'), ktx.item(i));
      }
    </script>

  </body>
</html>
