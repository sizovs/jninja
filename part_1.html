<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="ocean.css" />
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3, h4 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .large code { font-size: 1.5em }
      .large .hljs-comment { color: white !important}
      .squeez h3 { margin: 0.5em }
      .fade {color: #E0E0E0}
      .spanny { padding: 10px; color: white; background-color: #0b1c2e }
      .nopadding { padding: 0 }
      .libs { background-color: #202020}
      .l50 { float: left; width: 50%; }
      .r50 { float: right; width: 50%; }
      .crap pre { border-right: 5px solid #D81F2A; }
      .nice pre { border-right: 5px solid #69F0AE; }
      /* new */
      .example { background-color: #2b303b}
      .example h2, .example h3 { color: #fff; font-weight: bold; line-height: 0;}
      .example h1 { color: #fff; font-weight: bold; padding: 10px }

      .codeonly h1, .codeonly h2, .codeonly h3, .codeonly h4 { color: white }
      .codeonly { padding: 1em; background-color: #2b303b }
      .codeonly pre { margin: 0 }

      .remark-code-line-highlighted { background-color: #2d9967; color: white}
      .remark-code-line-highlighted * { color: white !important; }

      .remark-slide-scaler { -webkit-box-shadow: 0 !important; box-shadow: none !important; }
      .remark-slide-container {background-color: #2b303b}
      /* new end */
      .corner {border: 5px solid #85C1E9; position: absolute; top: 0px; right: 0px; width: 50%; background-color: #F0F0F0}
      .corner pre {margin: 0; padding: 0}
      .corner.long {height: 300px;}

      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .invert { background-color: black; color: white; }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}
      .strike { text-decoration: line-through; }
      .lint { background-color: #f3f3f3; }
      .conversation h3 { margin: 17px; font-size: 28px; }
      .img100 img { width: 100%}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle, example
# Effective Java Software Design
???
- Introduce myself and let others introduce themselves.
- Setting expectations
- Not Java 8 course

---
class: squeez
# Part I

--

## - naming &amp; OO construction

--

## - fighting nulls

--

## - fighting feature bloat

---
# Part II

--

## - application layer

--

## - tx

--

## - validation

--

## - persistence

--

## - fault tolerance

---

# Part III

--

## - Homework

--

## - Homework review

---
class: center, middle
# Part I
### let's warm up...

---
class: codeonly
.nice[
```java
@RestController
class RegistrationEndpoint {
  @PostMapping
  void post(@RequestParam String username) { ... }
}
```
]

--

.nice[
```java
class MethodArgumentNames {

  void print() {
      Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
      Arrays
          .stream(methods)
          .flatMap(method -> stream(method.getParameters()))
          .map(Parameter::getName)
          .forEach(System.out::println); // arg0 or username
  }  
}
```
]

--

### Any design smells?

---
class: codeonly
### Don't mix arrows and method references within a Monad
.nice[
```java
class MethodArgumentNames {

  void print() {
    Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
    Arrays
        .stream(methods)
*       .flatMap(this::parameters)
        .map(Parameter::getName)
        .forEach(System.out::println);
  }

  private Stream<Parameter> parameters(Method method) {
     return Arrays.stream(method.getParameters());
  }  
}

```
]

---
class: codeonly
### +1 requirement: fail fast if parameter names are not accessible

--

.nice[
```java
class MethodArgumentNames {

  void print() {
    Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
    Arrays
        .stream(methods)
        .flatMap(this::parameters)
*       .map(this::name)
        .forEach(System.out::println);
  }

  private String name(Parameter parameter) {
      boolean parameterHasAName = parameter.isNamePresent();
      checkArgument(parameterHasAName,
        "Parameter %s does not have a name. Please compile with --parameter flag", parameter);
      return parameter.getName();
  }
}
```
]

--

### Can we do any better?

---
class: codeonly

### Push complexity away where it's not visible

--

.nice[
```java
class MethodArgumentNames {

  void print() {
    Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
    Arrays
        .stream(methods)
        .flatMap(this::parameters)
*       .map(ParameterName::new)
        .forEach(System.out::println);
  }

  private class ParameterName {

      private final String name;

      ParameterName(Parameter parameter) {
          boolean parameterHasAName = parameter.isNamePresent();
          checkArgument(parameterHasAName,
              "Parameter %s does not have a name. Please compile with --parameter flag", parameter);
          this.name = parameter.getName();
      }

      @Override
      public String toString() {
          return this.name;
      }
  }
}
```
]
???
stepdown rule issue (where to put shared code)

---
class: codeonly
### **implicit conversion**

```java
class BitcoinExchange {
    BitcoinExchange(BitcoinExchange.Rate rate) {
        this.rate = rate;
    }
    void sell(Bitcoin btc) { ... rate.decimal() ... }
    void buy(Bitcoin btc) { ... rate.decimal() ... }

    @FunctionalInterface
    interface Rate {
        BigDecimal decimal();
    }
}
```

--
```java
class Coinbase {
    public BigDecimal exchangeRate() {
        return remoteApi.fetchExchangeRate();
    }
}
```

--

```java
Coinbase coinbase = new Coinbase();
```
--

```java
*BitcoinExchange exchange = new BitcoinExchange(coinbase::exchangeRate);
```

### no need to implement BitcoinExchange.Rate interface 

---

class: center, middle, codeonly
# Take-away: stick to Interface Segregation Principle. 
### @FunctionalInterface is your best friend
???
this way you can eliminate factories, wrappers.

---
class: codeonly
### **dealing with checked exceptions**
.crap[
```java
    int from = 8000;
    int to = 9000;
    IntStream
      .rangeClosed(from, to)
      .mapToObj(Port::new)
      .filter(p -> {
          try {
              return p.free();
          } catch (IOException e) {
              throw new RuntimeException(e);
          }
      })
      .findFirst();
```
]

--

class: codeonly

### noexception.machinezoo.com

.nice[
```java
    IntStream
      .rangeClosed(from, to)
      .mapToObj(Port::new)
*     .filter(sneak().supplier(Port::free)) // throw checked exception and trick the compiler
      .findFirst();
```
]

---
class: codeonly

.crap[
```java
public String json() {
  try {
    return mapper.writeValueAsString(this);
  } catch (JsonProcessingException | IOException e) {
    throw new RuntimeException(e);
  }
}
```            
]

--

.nice[
```java
public String json() {
  return sneak().get(() -> mapper.writeValueAsString(attribute));
}
```
]

--

.crap[
```java


Master master = new Master();
Slave slave = new Slave();

Connection connection;
try {
    connection = master.connection();
} catch (RuntimeException e) {
    log.warning(e);
    connection = slave.connection();
}
```            
]

--

.nice[
```java
Connection connection = Exceptions
*   .log()
    .get(master::connection)
    .orElseGet(slave::connection);
```
]

---
class: center, middle, example
# Naming

---
class: codeonly
```java
@WhatDoYouExpectToHappen
void code() {
  Entity entity ...
  dao.update(entity);
}
```

--

.crap[
```java
void update(Entity entity) {
  if (!entity.isIdAssigned()) {
    return;
  }
}
```
]

--

.nice[
```java
void update(Entity entity) {
  checkArgument(entity.isIdAssigned(), "Cannot update entity. Id is missing");
  ...
}
```
]

--

```java
void updateIfIdAssigned(Entity entity) {
  if (!entity.isIdAssigned()) {
    return;
  }
  ...
}
```

---
class: codeonly
.crap[
```java
interface Employee {
  String employeeAddress();
}
```
]

--

.nice[
```java
interface Employee {
  String address();
}
```
]

--

.crap[
```java
class Transaction {
  enum TransactionScope { }
}
```
]

--

.nice[
```java
class Transaction {
  enum Scope { }
}
```
]

--

.crap[
```java
package org.framework.batch
interface Reader { }
interface Operation { }
```
]

--

.nice[
```java
interface BatchReader { }
interface BatchOperation { }
```
]

--

.nice[
```java
interface Batch {
  interface Reader { }
  interface Operation { }
}
```
]

---

class: codeonly

#### Fields, parameters, variables are **nouns**. Command methods are **verbs**. Boolean methods are **adjectives**.

.crap[
```java
class Touchscreen {
  void touch() {
    this.touched++;
    this.touchedAt = LocalDateTime.now(UTC);
  }
}
```
]

--

```java
class Touchscreen {
  void touch() {
*   this.touchTimes++;
*   this.touchTime = LocalDateTime.now(UTC);
  }
```

--

```java
  boolean touched() {
    return touchTimes > 0;
  }

  boolean touched(LocalDateTime someTime) {
    return this.touchTime.equals(someTime);
  }
```

--

```java


if (touchscreen.touched()) {
  ...
}

if (touchscreen.touched(yesterday) {
  ...
})
```

---
class: codeonly
.crap[
```java
interface TransactionManager {
  void cancelTransaction(Transaction transaction) { ... } 
}
```
]

--

.nice[
```java
interface TransactionManager {
  void cancel(Transaction transaction) { ... } 
}
```
]

--

.crap[
```java
class Widget {
    long length();
```
]

--

.crap[
```java
class Widget {
    long lengthInPixels();
```
]

--

.nice[
```java
class Widget {
    Pixels length();
```
]

--

.crap[
```java
interface Movie {
    void stream(Channel channel);
```
]

--

.nice[
```java
interface Movie {
    void streamInto(Channel channel);
```
]

---
class: center, middle
## Compound names usually indicate a missing root object

---
class: codeonly
```java
class AwsS3Bucket {

  private final String awsPassword;
  private final String awsLogin;
  private final String bucketName;

  public AwsS3Bucket(String awsLogin, String awsPassword, String bucketName) {
    this.awsLogin = awsLogin;
    this.awsPassword = awsPassword;
    this.bucketName = bucketName;
  }

  void create() {
    ...
  }

}
```

--

```java
class AwsCredentials {

  public final String login;
  public final String password;

  public AwsCredentials(String login, String password) {
    this.login = login;
    this.password = password;
  }
}
```

---
class: codeonly
```java
class AwsS3Bucket {

  private final AWSCredentials awsCredentials;
  private final String bucketName;

  public AwsS3Bucket(AwsCredentials awsCredentials, String bucketName) {
    this.awsCredentials = awsCredentials;
    this.bucketName = bucketName;
  }

  void create() {
    ...
  }

}
```

--

```java
class AwsAccount {

  private final AwsCredentials credentials;

  public AwsAccount(AwsCredentials credentials) {
    this.credentials = credentials;
  }

}
```

---
class: codeonly
```java
class AwsS3Bucket {

  private final AwsAccount account;
  private final String name;

  public AwsS3Bucket(AwsAccount account, String name) {
    this.account = account;
    this.name = name;
  }

  void create() {
    ...
  }

}
```

---
class: codeonly
.crap[
```java
interface MusicApp {
    void playMusic();
    void stopMusic();
}
```
]

--

.nice[
```java
interface Music {
    void stop();
    void play();
}
```
]

--

.nice[
```java
interface MusicApp {
    Music music();
}
```
]

--

class: codeonly
.crap[
```java
interface Chat {
    void sendMessage(String channel, String mesage);
}
```
]

--

class: codeonly
.nice[
```java
interface Channel {
    void send(String message);
}
```
]

--

.nice[
```java
interface Chat {
    Channel channel(String name);
}
```
]

---
class: center, middle
# From old-school procedures to Objects

---
class: codeonly

```java
class File { }
```

--

.crap[
```java
class FileReader {

   String read(File file) { ... }
   

```
]

--
  
.crap[
```java
   boolean hasText(File file) { ... }
```
]

--
  
.crap[
```java
   Stream<String> lines(File file) { ... }
```
]

--
  
.crap[
```java
   String read(Path path) { ... }

   boolean hasText(Path path) { ... }

   Stream<String> lines(Path path) { ... }
```
]

--

.nice[
```java



class TextFile {

   TextFile(Path) { ... }
   TextFile(File) { ... }
```
]

--

.nice[
```java
   String text();
```
]

--

.nice[
```java
   boolean isEmpty();
```
]

--

.nice[
```java
   Stream<String> lines();
```
]

--

### Wins? ðŸš€ 

---
class: codeonly

### Encapsulate state, if possible

.crap[
```java
interface EmailSender {
  void send(Email email);
}
```
]

--

.nice[
```java
interface Email {
  void deliver();
}
```]

--

.crap[
```java
interface ConditionChecker {
  boolean checkCondition(Condition condition)
}
```
]

--

.nice[```java
interface Condition {
  boolean isFulfilled();
}
```
]

--

.crap[
```java
interface CredentialValidator {
  boolean validated(String username, String password);
}
```
]

--

.nice[```java
interface Credentials {
  boolean areValid();
}
```
]

--

.crap[
```java
interface RegistrationService {
  void register(String username, String password);
}
```
]

--

.nice[```java
interface Registration {
  void complete();
}
```
]

---
class: codeonly
.crap[
```java
class BankruptcyProbabilityCalculator {
    BigDecimal calculate(Business business) { ... }
}

class BankruptcyProbabilityUtils {
  boolean isHigh(DecimalNumber decimal) { ... }
}

```
]

--

.nice[
```java
class BankruptcyProbability extends DecimalNumber {
    Probability(Business business) { ... }
    boolean isHigh(); 

}
```
]

.crap[
```java
class BillingAgreement {
    private int term;

```
]

--

.nice[
```java
    private Term term;

```
]

--

.crap[
```java
class Company {
    private String vatNumber;
```
]

--

.nice[
```java
    private VatNumber vatNumber;
```
]

--

.crap[
```java
class Payment {
    private BigDecimal amount;
    private BigDecimal currency;
```
]

--

.nice[
```java
    private Amount amount;
```
]

--

.crap[
```java
class Loan {
    private User user;
```
]

--

.nice[
```java
    private Borrower borrower;
```
]

---
class: center, middle
# Methods are either **commands** or **queries**.
### Use commands (verbs) to tell an object what to do.
### With queries (nouns) you ask object to give something.
â€” *[Command/Query Separation](http://martinfowler.com/bliki/CommandQuerySeparation.html)*

---
class: codeonly
.crap[
```java
interface Iterator<T> {

  @NounWithASideAffect
  @ViolatesCqs
  T next();
}
```
]

--

.nice[
```java
interface Iterator<T> {

  @VerbThatReturnsNothing
  void advance();

  @NounThatReturnsStuff
  T current();
}
```
]

--

.crap[
```java





InputStream stream = url.load();
```
]

--

.nice[
```java
InputStream stream = url.content();
```
]

--

```java
url.load().transferTo(...)

url.content().transferTo(...)
```

---
class: center, middle
# Never use getters in your OO code.

---

## Getters are verbs

--

## Get **may** have a side effect

--

### - get married

--

### - get money from the ATM

--

### - get from A to B...

---
class: codeonly
```java
class Client {
  String fullName();
  String personalId();
}
```
???
consider readability if (client.fullName()) vs. if (client.getFullName())

--

```java

if (client.getFullName().equals("...")) {

}

if (client.fullName().equals("...")) {

}


```

--

```java
interface Iterator<T> {
  T current();
}
```

--

```java
if (iterator.getCurrent().pointsTo(anObject)) {

}

if (iterator.current().pointsTo(anObject)) {

}
```

---
class: center, middle
## Blindly removing get\* prefix will remove noise, but won't make your code more object-oriented.
### **Tell, don't ask** as much as you can.


---
class: center, middle
# Never use setters in your OO code.

---
class: codeonly
.crap[
```java
Borrower borrower = new Borrower();
borrower.setFirstName(firstName);
borrower.setLastName(lastName);
```
]

--

.nice[
```java
borrower.giveName(String firstName, String lastName);
```
]

--

.nice[
```java
borrower.give(Name name);
```
]


--

.crap[
```java
borrower.setAcceptedAgreement(Agreement agreement);
```
]

--

.nice[
```java
borrower.accept(Agreement agreement);
```
]

--

.crap[
```java
agreement.setSigned(boolean agreementSigned);
```
]

--

.nice[
```java
agreement.sign();
```
]

--

.nice[
```java
agreement.callOff();
```
]

--

.crap[
```java
blog.setTags(Tag... tags);
```
]

--

.nice[
```java
blog.tag(Tag... tag);
```
]

--

.nice[
```java
conference.addSpeaker(Speaker speaker);
```
]

--

.crap[
```java
conference.accept(Speaker speaker);
```
]

--

### Wait, but why?!

---
# Data structures

--

## - DTOs, Java beans...

--

## - do not have behaviour

--

## - **can** have getters and setters (but should they?)

---
class: codeonly
```java
class User {
    private final String firstName;
    private final String lastName;
    private String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    // getters and a setter for middleName

    @Override
    public String toString() {
        return "User{" +
                "firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", middleName='" + middleName + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return "User{" +
                "firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", middleName='" + middleName + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this);
    }

    @Override
    public boolean equals(Object o) {
        return EqualsBuilder.reflectionEquals(this, that);
    }

    @Override
    public int hashCode() {
        return HashCodeBuilder.reflectionHashCode(this);
    }
}
```

---
class: codeonly
```java
class User extends Data {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

}
```

--
```java
  User user = new User("Robert", "Martin");
  user.middleName = "Cecil"
```

---
class: center, middle, example
# Tony Hoare's billion dollar mistake

---
class: center, middle
## If nulls are possible, make them explicit. Rely on compiler to catch missing null checks.

---

class: codeonly
```kotlin

plugins {
  java
  id("net.ltgt.errorprone") version "0.8.1"
}

dependencies {
  errorprone("com.google.errorprone:error_prone_core:2.3.3")
  errorprone("com.uber.nullaway:nullaway:0.7.5")
}
```

--

```java
public String greet() {
  greetings(null);
  return null;
}

public String greetings(String name) {
  return "Hello, " + name;
}
```

--

```whatever

[NullAway] returning @Nullable expression from method with @NonNull return type
1 warning

[NullAway] passing @Nullable parameter 'null' where @NonNull is required
1 warning
```

---
class: center, middle
## In new code, use optionals.

---
class: codeonly
.crap[
```java
@ReturnsNullIfNumberIsNotFound
interface PhoneBook {
  PhoneNumber phoneNumber(String regex);
}
```
]

--

.nice[
```java
interface PhoneBook {
  Optional<PhoneNumber> phoneNumber(String regex);
}
```
]

--

```java
void ifPresent() {
  Optional<PhoneNumber> phoneNumber = phoneBook.phoneNumber(...);
  phoneNumber.ifPresent(paymentReminder::send);
}
```

--

```java
void orElse() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...)
      .orElse(PhoneNumber.USA_PRESIDENT);
}
```

--

```java
void orElseThrow() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...)
      .orElseThrow(() -> new PhoneNumberLookupFailed(regex)
}
```

---

class: codeonly
.crap[
```java
PhoneNumber phoneNumber = phoneBook.phoneNumber(...);
if (phoneNumber != null) {
  FacebookProfile facebookProfile = facebook.profile(phoneNumber);
  if (facebookProfile != null) {
    Picture picture = facebookProfile.picture();
    if (picture != null) {
      picture.download();
    }
  }
}
```
]

--

.nice[
```java
phoneBook.phoneNumber(...)
    .flatMap(facebook::profile)
    .flatMap(FacebookProfile::picture)
    .ifPresent(ProfilePicture::download);
```
]

---
class: codeonly
```java
@RegexIsOptional
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(String regex);
}
```

--

```java
interface Mask {

  Mask ANY = phoneNumber -> true;

  boolean matches(PhoneNumber phoneNumber);
}
```

--

```java
class Regex implements Mask {

  private final Pattern regex;

  @Override
  public boolean matches(PhoneNumber phoneNumber) {
    return regex.asPredicate().test(phoneNumber.toString());
  }
}
```

--

```java
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(Mask mask);
}```

--

```java
phoneBook.phoneNumbers(Mask.ANY);

phoneBook.phoneNumbers(new Regex(...));

```

---
class: center, middle
## When necessary, use Null Objects.


---
class: codeonly

.crap[
```java
public interface Scheduler {
  void schedule(Command command);
}

@Component
class SchedulerHolder {
  private static Scheduler INSTANCE;

  public SchedulerHolder(Scheduler scheduler) {
    SchedulerHolder.INSTANCE = requireNonNull(scheduler, "Scheduler cannot be null");
  }

  public static Scheduler get() {
    return INSTANCE;
  }
}
```
]

--

.nice[
```java
@Component
class SchedulerHolder {
* private static Scheduler INSTANCE = new NoScheduler();
  ...
}

class NoScheduler implements Scheduler {

  @Override
  public void schedule(Command command) {
    throw new NoSchedulerException(command.getClass().getSimpleName());
  }
}

```
]

---
class: middle, center, example
# Fighting feature bloat
### ... because we want to keep object's behaviour next to the state

---
class: codeonly

```java
class *Helper
```

--

```java
class *Utils
```

--

```java
class *Processor
```



--

```java
class *Manager
```

--

```java
class *Service
```


---
class: codeonly
.crap[
```java
@TwoInterwovenConceptsAreHidingInside
@FileSuffixAndDirIndicateMissingObject
class FtpUtils {

  void transferFile(File file, File newLocation)

  boolean fileExists(String filename);

  void makeDir(String parentDir, String dir);

  boolean folderExists(String folder);

}
```
]

--

class: codeonly
.crap[
```java
@StillProcedural
class FtpClient {

  void transferFile(File file, File newLocation)

  boolean fileExists(String filename);

  void makeDir(String parentDir, String dir);

  boolean folderExists(String folder);

}
```
]

---
class: codeonly

.nice[
```java
class FtpFolder {

  void createIn(FtpFolder parent);

  boolean exists();

}
```
]

--

.nice[
```java
class FtpFile {

  void transferTo(FtpFolder destination)

  boolean exists();

}
```
]

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Collection<Like> likes() {
        return ImmutableList.copyOf(likes);
    }

    public void like(Like like) {
        likes.add(like);
    }

    public long totalLikes() {
        return likes.size();
    }

    public void deleteLikeBy(LikeId id) {
        var like = likes.stream().filter(like => like.hasId(id)).findFirst()

        checkState(like.comesFrom(App.me()), "You can only delete your own likes");
        checkState(!like.isOlderThan(days(3)), "You can only delete likes no older than 3 days");
        
        likes.remove(like);
   }
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Likes likes() {
        return new Likes();
    }

    class Likes {

        public void put(Like like) {
            likes.add(like);
        }

        public long total() {
            return likes.size();
        }

        public Collection<Like> all() {
          return ImmutableList.copyOf(likes);
        }

        public void deleteLikeBy(LikeId id) {
          var like = likes.stream().filter(like => like.hasId(id)).findFirst()

          checkState(like.comesFrom(App.me()), "You can only delete your own likes");
          checkState(!like.isOlderThan(days(3)), "You can only delete likes no older than 3 days");

          likes.remove(like);
        }
    }
}
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Likes likes() {
        return new Likes();
    }

    class Likes extends ForwardingList<Like> {

        @Override
        protected List<Like> delegate() {
            return likes;
        }

        public void deleteLikeBy(LikeId id) {
          var like = likes.stream().filter(like => like.hasId(id)).findFirst()

          checkState(like.comesFrom(App.me()), "You can only delete your own likes");
          checkState(!like.isOlderThan(days(3)), "You can only delete likes no older than 3 days");
          
          likes.remove(like);
        }
    }
}
```

---
class: center, middle
## Total likes during Black Friday?

---
class: codeonly
```java
class BlackFriday {
```

--

```java
    public boolean fallsOn(LocalDate date) {
        var blackFriday = thanksgiving.plusDays(1);
        return blackFriday.isEqual(date);
    }
```

--

```java
    private LocalDate thanksgiving() {
        return LocalDate
          .now()
          .with(Month.NOVEMBER)
          .with(TemporalAdjusters.lastInMonth(THURSDAY));
    }
}
```

--

```java
class Likes {
    ...
    public long totalDuring(BlackFriday blackFriday) {
        return likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
    ...
}
```


---
class: center, middle
# Projections


---
class: codeonly
```java
@FunctionalInterface
interface Projection<T, R> {
    R of(T entity);
}
```

--

```java
public interface Entity<T> {
    default <R> R __(Projection<T, R> projection) {
        return projection.of((T) this);
    }
}
```

--

```java
class Likes implements Entity<Likes> {
  ...
}
```

--

```java
class TotalDuringBlackFriday implements Projection<Tweet.Likes, Long> {

    private final BlackFriday blackFriday = new BlackFriday();

    @Override
    public Long of(Tweet.Likes likes) {
        return
          likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
}
```

--

```java
Tweet tweet = ...
Tweet.Likes likes = tweet.likes();
long total = likes.__(new TotalDuringBlackFriday());
```
???
- must side effect free!
- btw, can be written inline, as lambdas
- PACKAGING MATTERS! under .likes


---
class: center, middle
# Specifications

---
class: codeonly
```java

@FunctionalInterface
interface Specification<T> {
    boolean isSatisfiedBy(T entity);
}
```

--

```java
public interface Entity<T> {
    default <R> R __(Projection<T, R> projection) {
        return projection.of((T) this);
    }

    default boolean __(Specification<T> specification) {
        return specification.isSatisfiedBy((T) this);
    }
}
```

--

```java
class HasGottenMillionLikesOnAPostingDay implements Specification<Tweet> {

        @Override
        public boolean isSatisfiedBy(Tweet tweet) {
            long likesOnAPostingDay = tweet
                    .likes()
                    .stream()
                    .filter(like -> like.isGivenOn(tweet.date()))
                    .count();
            return likesOnAPostingDay >= 1000000;
        }
    }
```

--
```java
Tweet tweet = ...
boolean milionLikesInADay = tweet.__(new HasGottenMillionLikesOnAPostingDay());
```

---

class: center, middle
# Multiple entities per row

---
class: codeonly
```java
@Entity
class Person {

  String firstName, lastName;

  Collection<Friend> friends = new ArrayList<>();
  Collection<Bitcoin> bitcoins = new ArrayList<>();

  public void buy(Bitcoin bitcoin) {
    this.bitcoins.add(bitcoin);
  }

  public void unfriendAll() {
    friends.forEach(this::unfriend);
  }
}
```

--

```java



package com.app.people;

@Entity
@Table(name = "PEOPLE")
class Person {

  String firstName, lastName;

}
```

---

class: codeonly

```java
package com.app.people;

@Entity
@Table(name = "PEOPLE")
class Person {

  String firstName, lastName;

}
```

--

```java
package com.app.people.networking;

@Entity
@Table(name = "PEOPLE")
class Networker {

  Collection<Friend> friends = new ArrayList<>();

  public void unfriendAll() {
    friends.forEach(this::unfriend);
  }    
}
```

--

```java
package com.app.trading;

@Entity
@Table(name = "PEOPLE")
class Trader {

  Collection<Bitcoin> bitcoins = new ArrayList<>();

  public void buy(Bitcoin bitcoin) {
    this.bitcoins.add(bitcoin);
  }
}
```


    </textarea>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"></script>
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        click: true,
        touch: true,
        slideNumberFormat: function (current, total) { return "" }
      });
      slideshow.on('afterShowSlide', function (slide) {

        var axs =  {
                  title: 'thoughput / responsiveness over time.',
                  xaxis: {
                    title: 'time (months)'
                  },
                  yaxis: {
                    title: 'throughput / responsiveness (RTF / sprint)'
                  }
                }

        var thr = [
                {
                  x: [2, 10, 14, 24, 40],
                  y: [30, 29, 28, 23, 10],
                  name: 'continuous degradation',
                  mode: 'lines',
                  line: {
                      color: 'rgb(219, 64, 82)',
                      width: 3
                    }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30, 30, 30, 30],
                  name: 'sustainable pace',
                  mode: 'lines',
                  line: {
                      color: 'rgb(169, 169, 169)'
                  }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30.5, 31, 31.5, 32],
                  name: 'continuous improvement',
                  mode: 'lines'
                },
          ];

          var dbt = thr.concat({
                  x: [28, 28],
                  y: [30, 20],
                  name: 'technical debt',
                  mode: 'lines',
                  line: {
                    dash: 'dot'
                  }
                } );

        if (slide.properties.name == "throughput") {
          Plotly.newPlot('throughput', thr, axs);
        }
        if (slide.properties.name == "debt") {
          Plotly.newPlot('debt', dbt, axs);
        }
      });

    var ktx = document.getElementsByClassName("ktx");
    for(var i = 0; i < ktx.length; i++) {
       katex.render(ktx.item(i).getAttribute('expr'), ktx.item(i));
      }
    </script>

  </body>
</html>
